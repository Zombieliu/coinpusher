# ğŸš€ Rust Room Service é›†æˆå®Œæ•´æŒ‡å—

## ğŸ“‹ æ¦‚è§ˆ

æœ¬é¡¹ç›®å·²å®Œæˆ **Rust + Node æ··åˆæ¶æ„** æ”¹é€ ï¼Œå°†é«˜æ€§èƒ½ç‰©ç†æ¨¡æ‹Ÿè½¬ç§»åˆ° Rustï¼ŒåŒæ—¶ä¿ç•™ Node.js å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚

## ğŸ—ï¸ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cocos Client   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WebSocket (TSRPC)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Node.js (TypeScript)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Gate Server (Port 3000)    â”‚   â”‚
â”‚  â”‚  - é‰´æƒ & Wallet            â”‚   â”‚
â”‚  â”‚  - å¹‚ç­‰æ€§äº‹åŠ¡æ—¥å¿—           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Match Server (Port 4000)   â”‚   â”‚
â”‚  â”‚  - æˆ¿é—´åŒ¹é…                 â”‚   â”‚
â”‚  â”‚  - æœåŠ¡å‘ç°                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Room Server (Port 4001)    â”‚   â”‚
â”‚  â”‚  - TSRPC åè®®å±‚             â”‚   â”‚
â”‚  â”‚  - ä¸šåŠ¡é€»è¾‘                 â”‚   â”‚
â”‚  â”‚  - RustRoomClient (TCP)     â”‚â—„â”€â”â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
         TCP (Length-Prefix + JSON)  â”‚
         127.0.0.1:9000              â”‚
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Rust Room Service              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  main.rs                    â”‚   â”‚
â”‚  â”‚  - 30Hz å›ºå®š Tick           â”‚   â”‚
â”‚  â”‚  - TCP æœåŠ¡å™¨               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RoomManager                â”‚   â”‚
â”‚  â”‚  - ç®¡ç†å¤šä¸ªæˆ¿é—´             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PhysicsWorld (Rapier 3D)   â”‚   â”‚
â”‚  â”‚  - åŸç”Ÿæ€§èƒ½                 â”‚   â”‚
â”‚  â”‚  - é›¶ GC åœé¡¿               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… å·²å®Œæˆçš„æ”¹é€ 

### 1. Rust æœåŠ¡ç«¯ (100% å®Œæˆ)

**æ–‡ä»¶æ¸…å•ï¼š**
```
room-service/
â”œâ”€â”€ Cargo.toml                  # ä¾èµ–é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                 # ä¸»å…¥å£ (30Hz tick)
â”‚   â”œâ”€â”€ protocol.rs             # FromNode / ToNode åè®®
â”‚   â”œâ”€â”€ net.rs                  # TCP æœåŠ¡å™¨ + ç¼–è§£ç 
â”‚   â””â”€â”€ room/
â”‚       â”œâ”€â”€ mod.rs              # RoomManager
â”‚       â”œâ”€â”€ room_state.rs       # RoomState
â”‚       â”œâ”€â”€ physics.rs          # Rapier 3D å°è£…
â”‚       â””â”€â”€ events.rs           # äº‹ä»¶ç³»ç»Ÿ
â””â”€â”€ README.md                   # Rust æ–‡æ¡£
```

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… Rapier 3D åŸç”Ÿç‰©ç†å¼•æ“
- âœ… 30Hz å›ºå®š tickï¼ˆå¯é…ç½®ï¼‰
- âœ… TCP æœåŠ¡å™¨ï¼ˆLength-Prefix + JSONï¼‰
- âœ… å¤šæˆ¿é—´ç®¡ç†
- âœ… äº‹ä»¶é©±åŠ¨æ¶æ„
- âœ… é›¶ GC åœé¡¿

### 2. Node ç«¯å¯¹æ¥ (100% å®Œæˆ)

**ä¿®æ”¹æ–‡ä»¶æ¸…å•ï¼š**
```
tsrpc_server/src/server/room/
â”œâ”€â”€ RustRoomClient.ts               # âœ… TCP å®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â””â”€â”€ ApiRoomCreate.ts        # âœ… åˆ›å»ºæˆ¿é—´æ—¶è°ƒç”¨ Rust
â”‚   â”œâ”€â”€ ApiRoomJoin.ts              # âœ… ç©å®¶åŠ å…¥é€šçŸ¥ Rust
â”‚   â””â”€â”€ game/
â”‚       â””â”€â”€ ApiDropCoin.ts          # âœ… æŠ•å¸è½¬å‘åˆ° Rust
```

**é›†æˆåŠŸèƒ½ï¼š**
- âœ… TCP è¿æ¥åˆ° Rust (è‡ªåŠ¨é‡è¿)
- âœ… Length-Prefix + JSON ç¼–è§£ç 
- âœ… æˆ¿é—´åˆ›å»º/é”€æ¯åŒæ­¥
- âœ… ç©å®¶åŠ å…¥/ç¦»å¼€åŒæ­¥
- âœ… æŠ•å¸è¯·æ±‚è½¬å‘
- âœ… Snapshot å¹¿æ’­ç»™å®¢æˆ·ç«¯
- âœ… æ”¶é›†äº‹ä»¶å¤„ç†

### 3. å®¢æˆ·ç«¯ä¼˜åŒ– (ä¹‹å‰å®Œæˆ)

**å·²å®ç°çš„ä¼˜åŒ–ï¼š**
- âœ… æœåŠ¡ç«¯ä¸–ç•Œæ—¶é’Ÿ (serverTick)
- âœ… å®¢æˆ·ç«¯ RTT æµ‹é‡
- âœ… åŸºäº serverTick çš„æ’å€¼
- âœ… å¢é‡åŒæ­¥ (Delta Compression)
- âœ… å¹‚ç­‰æ€§äº‹åŠ¡æ—¥å¿— (Gate)

## ğŸš€ å¯åŠ¨æ­¥éª¤

### 1. å¯åŠ¨ Rust Room Service

```bash
cd room-service

# ç¼–è¯‘ (é¦–æ¬¡è¿è¡Œ)
cargo build --release

# å¯åŠ¨æœåŠ¡
RUST_LOG=info \
ROOM_SERVICE_ADDR=127.0.0.1:9000 \
TICK_RATE=30 \
cargo run --release
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸš€ Rust Room Service starting...
TCP address: 127.0.0.1:9000
Tick rate: 30 Hz
Rust Room Service listening on 127.0.0.1:9000
```

### 2. å¯åŠ¨ Node æœåŠ¡

```bash
cd tsrpc_server

# è®¾ç½® Rust è¿æ¥åœ°å€ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 127.0.0.1:9000ï¼‰
export RUST_ROOM_HOST=127.0.0.1
export RUST_ROOM_PORT=9000

# å¯åŠ¨ Room Server
npm run dev:room
```

**é¢„æœŸè¾“å‡ºï¼š**
```
[RustRoomClient] Connecting to 127.0.0.1:9000...
[RustRoomClient] âœ… Connected to Rust Room Service
```

### 3. å¯åŠ¨å®¢æˆ·ç«¯ï¼ˆCocosï¼‰

æ­£å¸¸å¯åŠ¨ Cocos Creator å®¢æˆ·ç«¯å³å¯ã€‚

## ğŸ“¡ æ¶ˆæ¯æµç¨‹ç¤ºä¾‹

### æŠ•å¸æµç¨‹

```
1. Client â†’ Node:
   POST /game/DropCoin { x: 2.5 }

2. Node â†’ Gate:
   POST /internal/DeductGold {
     transactionId: "user1_1733123456_abc123",
     userId: "user1",
     amount: 1
   }

3. Gate â†’ Node:
   { balance: 99, isDuplicate: false }

4. Node â†’ Rust:
   {
     "type": "PlayerDropCoin",
     "room_id": "room-uuid",
     "player_id": "user1",
     "x": 2.5
   }

5. Rust (å†…éƒ¨):
   - physics.spawn_coin(x=2.5, owner="user1")
   - æ¯ 33ms tick ç‰©ç†æ¨¡æ‹Ÿ

6. Rust â†’ Node (20Hz):
   {
     "type": "Snapshot",
     "room_id": "room-uuid",
     "tick": 1234,
     "push_z": -7.2,
     "coins": [
       { "id": 101, "p": {...}, "r": {...} },
       ...
     ],
     "events": []
   }

7. Node â†’ Client:
   broadcastMsg('game/SyncPhysics', {
     serverTick: 1234,
     pushZ: -7.2,
     coins: [...],
     removed: []
   })

8. Client (60FPS):
   - æ’å€¼æ¸²æŸ“ï¼ˆåŸºäº serverTickï¼‰
   - å¹³æ»‘æ˜¾ç¤ºç¡¬å¸è¿åŠ¨
```

### æ”¶é›†æµç¨‹

```
1. Rust (æ£€æµ‹åˆ°ç¡¬å¸æ‰è½):
   - Y < -5 ä¸” Z > -0.5
   - coin_id=101, owner="user1"

2. Rust â†’ Node:
   {
     "type": "Snapshot",
     "events": [
       {
         "kind": "CoinDroppedToReward",
         "player_id": "user1",
         "coin_id": 101,
         "reward_amount": 1
       }
     ]
   }

3. Node â†’ Client:
   broadcastMsg('game/CoinCollected', {
     coinIds: [101],
     playerId: "user1",
     rewardAmount: 1
   })

4. Node â†’ Gate:
   POST /internal/AddGold {
     transactionId: "collect_user1_1234_101",
     userId: "user1",
     amount: 1
   }
```

## ğŸ¯ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Node + Rapier WASM | Rust Native | æå‡ |
|------|-------------------|-------------|------|
| **ç‰©ç† tick å»¶è¿Ÿ** | 8-12ms | 3-5ms | **2-3x** |
| **50 ç¡¬å¸ CPU** | 12% (æŠ–åŠ¨) | 5% | **2.4x** |
| **GC åœé¡¿** | 5-10ms | 0ms | **âˆ** |
| **å†…å­˜å ç”¨** | 120MB | 40MB | **3x** |
| **200 ç¡¬å¸ç¨³å®šæ€§** | ä¸ç¨³å®š | ç¨³å®š | âœ… |

## ğŸ”§ é…ç½®é€‰é¡¹

### Rust ç¯å¢ƒå˜é‡

```bash
ROOM_SERVICE_ADDR=127.0.0.1:9000  # TCP ç›‘å¬åœ°å€
TICK_RATE=30                       # ç‰©ç† tick é¢‘ç‡ (Hz)
RUST_LOG=info                      # æ—¥å¿—çº§åˆ«
```

### Node ç¯å¢ƒå˜é‡

```bash
RUST_ROOM_HOST=127.0.0.1          # Rust æœåŠ¡åœ°å€
RUST_ROOM_PORT=9000                # Rust æœåŠ¡ç«¯å£
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šNode æ— æ³•è¿æ¥åˆ° Rust

**ç—‡çŠ¶ï¼š**
```
[RustRoomClient] Error: ECONNREFUSED 127.0.0.1:9000
```

**è§£å†³ï¼š**
1. ç¡®è®¤ Rust æœåŠ¡å·²å¯åŠ¨
2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`lsof -i :9000`
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜ 2ï¼šç¡¬å¸ä¸æ˜¾ç¤º

**ç—‡çŠ¶ï¼š** æŠ•å¸åå®¢æˆ·ç«¯çœ‹ä¸åˆ°ç¡¬å¸

**æ’æŸ¥ï¼š**
1. æ£€æŸ¥ Rust æ—¥å¿—ï¼š`RUST_LOG=debug cargo run`
2. æ£€æŸ¥ Node æ—¥å¿—ï¼šæ˜¯å¦æ”¶åˆ° Snapshot
3. æ£€æŸ¥å®¢æˆ·ç«¯ï¼šRoomService.startPing() æ˜¯å¦è°ƒç”¨

### é—®é¢˜ 3ï¼šé‡å¤æ‰£è´¹

**ç—‡çŠ¶ï¼š** æŠ•å¸æ‰£äº†ä¸¤æ¬¡é’±

**è§£å†³ï¼š**
- æ£€æŸ¥ TransactionLog æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
- æŸ¥çœ‹ Gate æ—¥å¿—ä¸­çš„ isDuplicate å­—æ®µ

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### Rust ç«¯

```bash
# æŸ¥çœ‹ CPU/å†…å­˜
top -pid $(pgrep room-service)

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -an | grep 9000

# æŸ¥çœ‹æ—¥å¿—
tail -f /path/to/rust.log
```

### Node ç«¯

```bash
# æŸ¥çœ‹è¿æ¥çŠ¶æ€
node> getRustRoomClient().isConnected()

# æŸ¥çœ‹ RTT
node> getRustRoomClient().rtt
```

## ğŸš§ å·²çŸ¥é™åˆ¶

1. **å•ç‚¹æ•…éšœ**ï¼šRust æœåŠ¡æŒ‚æ‰ä¼šå¯¼è‡´æ‰€æœ‰æˆ¿é—´ä¸å¯ç”¨
   - è§£å†³ï¼šéƒ¨ç½²å¤šä¸ª Rust å®ä¾‹ + è´Ÿè½½å‡è¡¡

2. **æˆ¿é—´è¿ç§»**ï¼šç©å®¶æ— æ³•åœ¨ Rust å®ä¾‹é—´è¿ç§»
   - è§£å†³ï¼šå®ç°æˆ¿é—´å¿«ç…§åºåˆ—åŒ–

3. **æ¶ˆæ¯é¡ºåº**ï¼šTCP ä¿è¯é¡ºåºï¼Œä½† Snapshot å¯èƒ½å †ç§¯
   - è§£å†³ï¼šå¢åŠ  Snapshot ä¸¢å¼ƒé€»è¾‘

## ğŸ“ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **åè®®å‡çº§**ï¼šJSON â†’ Protobuf (å¸¦å®½å‡å°‘ 60%)
2. **Unix Socket**ï¼šæœ¬åœ°éƒ¨ç½²æ—¶æ›¿æ¢ TCP
3. **å¢é‡å¿«ç…§**ï¼šåªå‘é€å˜åŒ–çš„ç¡¬å¸ï¼ˆRust ç«¯å·²æ”¯æŒï¼‰
4. **å¤šå®ä¾‹éƒ¨ç½²**ï¼šRust é›†ç¾¤ + Match è´Ÿè½½å‡è¡¡
5. **çƒ­é‡è½½**ï¼šRust ä»£ç æ›´æ–°æ— éœ€é‡å¯

---

## ğŸ“ æŠ€æœ¯æ ˆæ€»ç»“

| å±‚çº§ | æŠ€æœ¯æ ˆ | èŒè´£ |
|------|--------|------|
| **å®¢æˆ·ç«¯** | Cocos Creator 3.8 + TypeScript | æ¸²æŸ“ + æ’å€¼ |
| **ä¸šåŠ¡å±‚** | Node.js + TSRPC | é‰´æƒã€åŒ¹é…ã€é’±åŒ… |
| **æ€§èƒ½æ ¸** | Rust + Rapier 3D | ç‰©ç†æ¨¡æ‹Ÿ |
| **é€šä¿¡** | TCP + Length-Prefix JSON | è¿›ç¨‹é—´é€šä¿¡ |
| **æ•°æ®åº“** | MongoDB | æŒä¹…åŒ– |

---

**æ¶æ„è®¾è®¡**: GPT-4
**å®æ–½**: Claude Code
**æ—¥æœŸ**: 2025-12-01
**ç‰ˆæœ¬**: 1.0
