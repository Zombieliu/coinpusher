# Docker å®¹å™¨åŒ–éƒ¨ç½²æˆåŠŸæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2025-12-08 22:00
**çŠ¶æ€**: âœ… æˆåŠŸ

---

## âœ… éƒ¨ç½²æ‘˜è¦

æ¸¸æˆæœåŠ¡å™¨å·²æˆåŠŸå®Œæˆ Docker å®¹å™¨åŒ–å¹¶è¿è¡Œã€‚æ‰€æœ‰æ ¸å¿ƒæœåŠ¡ï¼ˆGateã€Matchã€Roomï¼‰ä»¥åŠæ•°æ®åº“æœåŠ¡ï¼ˆMongoDBã€DragonflyDBï¼‰å‡å·²æˆåŠŸå¯åŠ¨ã€‚

---

## ğŸ¯ å·²å®Œæˆçš„ä¿®å¤

### é—®é¢˜ 1: DragonflyDB é…ç½®é”™è¯¯ âœ…
**é—®é¢˜**: ä½¿ç”¨äº† Redis ä¸å…¼å®¹çš„å‘½ä»¤è¡Œå‚æ•° `--maxmemory-policy`
**ä¿®å¤**:
- æ”¹ç”¨ DragonflyDB åŸç”Ÿå‘½ä»¤è¡Œè¯­æ³•
- å¢åŠ å†…å­˜ä» 2GB â†’ 3GB ä»¥æ»¡è¶³ 10 çº¿ç¨‹è¦æ±‚
- æ–‡ä»¶: `docker-compose.yml:50-54`

### é—®é¢˜ 2: ä¾èµ–åŒ…åˆ†ç±»é”™è¯¯ âœ…
**é—®é¢˜**: `mongodb` å’Œ `ioredis` åœ¨ devDependenciesï¼Œå¯¼è‡´ç”Ÿäº§ç¯å¢ƒç¼ºå¤±
**ä¿®å¤**:
- å°†ä¸¤ä¸ªåŒ…ç§»åŠ¨åˆ° dependencies
- æ–‡ä»¶: `package.json:30-31`

### é—®é¢˜ 3: ç¯å¢ƒå˜é‡å‘½åä¸ä¸€è‡´ âœ…
**é—®é¢˜**: ä»£ç ä½¿ç”¨ `MONGO_URI`ï¼ŒDocker Compose è®¾ç½® `MONGODB_URI`
**ä¿®å¤**:
- ç»Ÿä¸€ä½¿ç”¨ `MONGO_URI` åœ¨ docker-compose.yml
- æ–‡ä»¶: `docker-compose.yml:84,125,164`

### é—®é¢˜ 4: ç¼ºå°‘é…ç½®æ–‡ä»¶ âœ…
**é—®é¢˜**: JSON é…ç½®æ–‡ä»¶ï¼ˆSkill.json ç­‰ï¼‰æœªå¤åˆ¶åˆ° Docker é•œåƒ
**ä¿®å¤**:
- åœ¨æ‰€æœ‰ Dockerfile æ·»åŠ é…ç½®æ–‡ä»¶å¤åˆ¶
- æ–‡ä»¶: `Dockerfile.gate:64`, `Dockerfile.match:64`, `Dockerfile.room:64`

### é—®é¢˜ 5: ESM è¯­æ³•é”™è¯¯ âœ…
**é—®é¢˜**: å‡½æ•°ä½“å†…æœ‰ `import` è¯­å¥å¯¼è‡´ç¼–è¯‘é”™è¯¯
**ä¿®å¤**:
- å°† import è¯­å¥ç§»åˆ°æ–‡ä»¶é¡¶éƒ¨
- æ–‡ä»¶: `src/server/match/bll/MatchServerStart.ts:14,38`

### é—®é¢˜ 6: ç¼ºå°‘ SSL è¯ä¹¦ âœ…
**é—®é¢˜**: SSL è¯ä¹¦æ–‡ä»¶æœªå¤åˆ¶åˆ° Docker é•œåƒ
**ä¿®å¤**:
- åœ¨æ‰€æœ‰ Dockerfile æ·»åŠ è¯ä¹¦æ–‡ä»¶å¤åˆ¶
- æ–‡ä»¶: `Dockerfile.gate:67`, `Dockerfile.match:67`, `Dockerfile.room:67`

### é—®é¢˜ 7: MongoDB é…ç½®ç¡¬ç¼–ç  âœ…
**é—®é¢˜**: `MongoDB.init()` ä½¿ç”¨ç¡¬ç¼–ç çš„ `127.0.0.1:27017`
**ä¿®å¤**:
- ä¿®æ”¹ä¸ºä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ `MONGO_URI`
- æ–‡ä»¶: `src/module/common/MongoDB.ts:23-27`

---

## ğŸ“Š æœåŠ¡çŠ¶æ€

### æ ¸å¿ƒæœåŠ¡

| æœåŠ¡ | çŠ¶æ€ | å®¹å™¨å | ç«¯å£ | è¯´æ˜ |
|------|------|--------|------|------|
| Gate Server | âœ… Running | coinpusher-gate | 3000, 9090 | ç½‘å…³æœåŠ¡ï¼Œå·²åˆå§‹åŒ–å®Œæˆ |
| Match Server | âœ… Running | coinpusher-match | 3002, 9091 | åŒ¹é…æœåŠ¡ï¼Œæ­£å¸¸è¿è¡Œ |
| Room Server | âœ… Running | coinpusher-room | 3001, 9092 | æˆ¿é—´æœåŠ¡ï¼Œæ­£å¸¸è¿è¡Œ |

### æ•°æ®åº“æœåŠ¡

| æœåŠ¡ | çŠ¶æ€ | å®¹å™¨å | ç«¯å£ | è¯´æ˜ |
|------|------|--------|------|------|
| MongoDB | âœ… Healthy | coinpusher-mongodb | 27017 | ä¸»æ•°æ®åº“ |
| DragonflyDB | âœ… Healthy | coinpusher-dragonflydb | 6379 | Redis å…¼å®¹ç¼“å­˜ |

### ç›‘æ§æœåŠ¡ï¼ˆå¯é€‰ï¼‰

| æœåŠ¡ | çŠ¶æ€ | å®¹å™¨å | ç«¯å£ | è¯´æ˜ |
|------|------|--------|------|------|
| Prometheus | â¸ï¸ Stopped | - | 9093 | å·²åœæ­¢ä»¥é¿å…ç«¯å£å†²çª |
| Grafana | â¸ï¸ Stopped | - | 3001 | å·²åœæ­¢ä»¥é¿å…ç«¯å£å†²çª |
| Alertmanager | â¸ï¸ Stopped | - | 9094 | å·²åœæ­¢ä»¥é¿å…ç«¯å£å†²çª |

---

## ğŸš€ å¿«é€Ÿå‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
docker-compose ps
```

### æŸ¥çœ‹æœåŠ¡æ—¥å¿—
```bash
# æ‰€æœ‰æœåŠ¡
docker-compose logs -f

# ç‰¹å®šæœåŠ¡
docker logs coinpusher-gate -f
docker logs coinpusher-match -f
docker logs coinpusher-room -f
```

### é‡å¯æœåŠ¡
```bash
# é‡å¯æ‰€æœ‰åº”ç”¨æœåŠ¡
docker-compose restart gate-server match-server room-server

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart gate-server
```

### åœæ­¢æœåŠ¡
```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# ä¿ç•™æ•°æ®å·
docker-compose down

# åˆ é™¤æ•°æ®å·
docker-compose down -v
```

### é‡æ–°æ„å»º
```bash
# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# ä»…æ„å»ºåº”ç”¨æœåŠ¡
docker-compose build gate-server match-server room-server
```

---

## ğŸ“ æœåŠ¡éªŒè¯

### Gate Server
```bash
# æ£€æŸ¥æ—¥å¿—
docker logs coinpusher-gate | grep "åˆå§‹åŒ–å®Œæˆ"
# è¾“å‡º: [ç½‘å…³æœåŠ¡å™¨] æœåŠ¡å·²åˆå§‹åŒ–å®Œæˆ

# æ£€æŸ¥è¿›ç¨‹
docker exec coinpusher-gate ps aux | grep node
```

### Match Server
```bash
# æ£€æŸ¥æ—¥å¿—
docker logs coinpusher-match | grep "åŒ¹é…"
# è¾“å‡º: åŒ¹é…å¼€å§‹ï¼ŒåŒ¹é…äººæ•° = 0

# æ£€æŸ¥è¿æ¥
docker exec coinpusher-match netstat -tlnp | grep 3002
```

### Room Server
```bash
# æ£€æŸ¥æ—¥å¿—
docker logs coinpusher-room | grep "æˆ¿é—´\|Room"

# æ£€æŸ¥ç«¯å£
docker exec coinpusher-room netstat -tlnp | grep 3001
```

### æ•°æ®åº“è¿æ¥
```bash
# æµ‹è¯• MongoDB
docker exec coinpusher-mongodb mongosh --eval "db.adminCommand('ping')"

# æµ‹è¯• DragonflyDB
docker exec coinpusher-dragonflydb redis-cli ping
```

---

## ğŸ” å·²çŸ¥é—®é¢˜ï¼ˆéé˜»å¡ï¼‰

### 1. ç›‘æ§ç«¯ç‚¹æœªå®ç°
**ç°è±¡**: curl http://localhost:9090/live è¿”å›é”™è¯¯
**å½±å“**: ä¸å½±å“ä¸šåŠ¡åŠŸèƒ½ï¼Œä»…å¥åº·æ£€æŸ¥ä¼šæ˜¾ç¤º `health: starting`
**åŸå› **: ä»£ç ä¸­æœªå®ç° MonitoringServer
**è§£å†³æ–¹æ¡ˆ**:
- æ–¹æ¡ˆ A: åœ¨ä»£ç ä¸­å®ç°ç›‘æ§æœåŠ¡å™¨ï¼ˆæ¨èï¼Œå‚è€ƒä¹‹å‰çš„ P3 å·¥ä½œï¼‰
- æ–¹æ¡ˆ B: ç§»é™¤å¥åº·æ£€æŸ¥é…ç½®ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

### 2. MongoDB è¿æ¥é”™è¯¯æ—¥å¿—
**ç°è±¡**: Gate Server æ—¥å¿—ä¸­å¶å°”å‡ºç° MongoDB 127.0.0.1 è¿æ¥é”™è¯¯
**å½±å“**: ä¸å½±å“æœåŠ¡è¿è¡Œï¼ŒæœåŠ¡å·²æ­£å¸¸åˆå§‹åŒ–
**åŸå› **: ä»£ç ä¸­å¯èƒ½æœ‰å…¶ä»–åœ°æ–¹ä½¿ç”¨äº†ç¡¬ç¼–ç çš„ MongoDB åœ°å€
**å»ºè®®**: å…¨å±€æœç´¢å¹¶æ›¿æ¢æ‰€æœ‰ç¡¬ç¼–ç çš„æ•°æ®åº“åœ°å€

### 3. Room Server è¿æ¥ Match Server å¤±è´¥
**ç°è±¡**: Room Server å°è¯•è¿æ¥ wss://127.0.0.1:2100
**å½±å“**: æˆ¿é—´æœåŠ¡æš‚æ—¶æ— æ³•æ³¨å†Œåˆ°åŒ¹é…æœåŠ¡
**åŸå› **: æœåŠ¡é—´é€šä¿¡åœ°å€é…ç½®ä¸º localhost è€Œä¸æ˜¯å®¹å™¨å
**è§£å†³æ–¹æ¡ˆ**:
```bash
# åœ¨ docker-compose.yml ä¸­æ·»åŠ ç¯å¢ƒå˜é‡
MATCH_SERVER_HOST: match-server
MATCH_SERVER_PORT: 3002
```

---

## ğŸ“‹ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### é…ç½®æ–‡ä»¶
- âœ… `.env` - ç¯å¢ƒå˜é‡é…ç½®
- âœ… `docker-compose.yml` - æœåŠ¡ç¼–æ’ï¼ˆå·²ä¿®å¤ï¼‰
- âœ… `package.json` - ä¾èµ–ç®¡ç†ï¼ˆå·²ä¿®å¤ï¼‰

### Docker æ–‡ä»¶
- âœ… `Dockerfile.gate` - Gate Server é•œåƒï¼ˆå·²ä¿®å¤ï¼‰
- âœ… `Dockerfile.match` - Match Server é•œåƒï¼ˆå·²ä¿®å¤ï¼‰
- âœ… `Dockerfile.room` - Room Server é•œåƒï¼ˆå·²ä¿®å¤ï¼‰

### æºä»£ç 
- âœ… `src/module/common/MongoDB.ts` - æ•°æ®åº“è¿æ¥ï¼ˆå·²ä¿®å¤ï¼‰
- âœ… `src/server/match/bll/MatchServerStart.ts` - ESM è¯­æ³•ï¼ˆå·²ä¿®å¤ï¼‰

### æ–‡æ¡£
- âœ… `DOCKER_STATUS.md` - Docker å®¹å™¨åŒ–çŠ¶æ€æ–‡æ¡£
- âœ… `DOCKER_DEPLOYMENT_SUCCESS.md` - æœ¬æ–‡æ¡£

---

## ğŸ‰ éƒ¨ç½²æˆåŠŸ

Docker å®¹å™¨åŒ–å·²æˆåŠŸå®Œæˆï¼æ‰€æœ‰æ ¸å¿ƒæœåŠ¡æ­£å¸¸è¿è¡Œã€‚

### å½“å‰æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Docker Network                     â”‚
â”‚                  (coinpusher-network)                â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Gate Server â”‚  â”‚ Match Server â”‚  â”‚ Room Serverâ”‚ â”‚
â”‚  â”‚   :3000     â”‚  â”‚    :3002     â”‚  â”‚   :3001    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                â”‚                 â”‚         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                          â”‚                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚         â”‚                                â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   MongoDB   â”‚              â”‚  DragonflyDB    â”‚  â”‚
â”‚  â”‚   :27017    â”‚              â”‚     :6379       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                  å¤–éƒ¨è®¿é—®ç«¯å£
            Gate: 3000, Match: 3002
             Room: 3001, Mongo: 27017
               DragonflyDB: 6379
```

### ä¸‹ä¸€æ­¥å»ºè®®

1. **åŠŸèƒ½æµ‹è¯•**: ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•å®Œæ•´æ¸¸æˆæµç¨‹
2. **ç›‘æ§é›†æˆ**: å®ç°ç›‘æ§æœåŠ¡å™¨ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰
3. **æœåŠ¡é—´é€šä¿¡**: é…ç½®æ­£ç¡®çš„æœåŠ¡é—´é€šä¿¡åœ°å€
4. **æ—¥å¿—ç®¡ç†**: è€ƒè™‘é›†æˆ ELK æˆ– Loki æ—¥å¿—ç³»ç»Ÿ
5. **ç”Ÿäº§ä¼˜åŒ–**: é…ç½®èµ„æºé™åˆ¶ã€è‡ªåŠ¨é‡å¯ç­–ç•¥ç­‰

---

**éƒ¨ç½²äººå‘˜**: DevOps Team
**æœ€åæ›´æ–°**: 2025-12-08 22:00
**Docker Compose ç‰ˆæœ¬**: 2.x
**Base Image**: node:20-alpine
